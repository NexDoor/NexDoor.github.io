<!DOCTYPE html>
<html>

<!--
  NEED TO CLEAN UP CODE
  RENAME VARS FOR READABILITY
  ADD TRY CATCH AND LOG ERRORS TO STATUS TAB / OR DIALOG
  
-->

   <head>
      <meta name = "viewport" content = "width = device-width, initial-scale = 1">
        

      <link rel = "stylesheet" href = "https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
      <script src = "https://code.jquery.com/jquery-1.11.3.min.js"></script>

        <!-- this fixes issue where button maintains pressed state if validation precents page change 
        <script type="text/javascript">
            $(document).bind('mobileinit', function () {
                $.mobile.activeBtnClass = 'aBtnSelector';
            });
        </script>
-->

      <script src = "https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

<!--
      <script src="//cdn.jsdelivr.net/particle-api-js/6.4.2/particle.min.js" type="text/javascript"></script>
-->
      <script src="https://cdn.jsdelivr.net/npm/particle-api-js@8/dist/particle.min.js" type="text/javascript"></script>


	<script>
		$(document).bind("mobileinit", function(){
			$.mobile.defaultPageTransition = 'slide';
		});
	</script>
	
    	

     	<link rel="icon" href="https://nexdoor.github.io/nd2.png">

        <link rel="shortcut icon" href="https://nexdoor.github.io/nd2.png" />
        <!-- for ios 7 style, multi-resolution icon of 152x152 -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-barstyle" content="black-translucent">
        <link rel="apple-touch-icon" href="https://nexdoor.github.io/nd2.png">
        <!-- for Chrome on Android, multi-resolution icon of 196x196 -->

        <link rel="apple-touch-icon-precomposed" sizes="android-only" href="https://nexdoor.github.io/nd2.png">


	    <link rel="shortcut icon" sizes="72x72" href="https://nexdoor.github.io/nd3.png"> 


        <meta name="mobile-web-app-capable" content="yes">
        <link rel="shortcut icon" href="https://nexdoor.github.io/NexDoor_72.png">
        
        <!-- IMPORTANT... the manifest MUST have .webmanifest extension, and the contents are specific and must be exact!!!-->
        <link rel="manifest" href="https://nexdoor.github.io/manifest.webmanifest">

<!--
        <meta name="mobile-web-app-capable" content="yes">
        <link rel="shortcut icon" href="https://nexdoor.github.io/NexDoor_72.png">
        
more info here on installing as an app
for Android, aka PWA, or Progressive Web App

https://web.dev/customize-install/

Demo here

https://web.dev/codelab-make-installable/

lblSelectedDevice
-->



      <style>

        
        @media only screen and (min-width: 600px){
            .ui-content {
              max-width: 600px;
              margin: 0 auto;
            }

            div[data-role="header"] {
                  max-width: 600px;
                  margin: 0 auto;
            }    
            
    
            div[data-role="footer"] {
                  max-width: 600px;
                  margin: 0 auto;
            }    
        
        	.ui-overlay-b{
        		background: #333;
        	}
        }

        #lblSelectedDevice {
            color: green;
            font-size: 100%;
        }

         #myspan {
          font-family: 'IBM Plex Mono', monospace;
          background-color: #F7F4F3;
          color: #000000;
         /* resize: none;
          height: 600px;*/
          height: 200px;
          padding: 1rem 1rem;
          overflow: auto;
        }
        
        #logSection {
          font-family: 'IBM Plex Mono', monospace;
          background-color: #F7F4F3;
          color: #000000;
         /* resize: none;
          height: 600px;*/
          height: 200px;
          padding: 1rem 1rem;
          overflow: scroll;
        }


        .mc-text-danger  {
            color:red;
        }
        

        
      </style>
      
      

   </head>
   
   <body>

    
    <!-- Login Page -->
      <div data-role = "page" id="Login" data-theme="a">
       <div data-role="header" data-theme="b">
            <h1 class="ui-title">NexDoor v3</h1>
        </div><!-- /header -->
        <div role="main" class="ui-content">
            <h3>Sign In</h3>
            <label for="txt-email">Email Address</label>
            <input type="email" name="txt-email" id="txt-email" value="">
            <label for="txt-password">Password</label>
            <input type="password" name="txt-password" id="txt-password" value="">
            <!-- this can be implemented later
            <fieldset data-role="controlgroup">
                <input type="checkbox" name="chck-rememberme" id="chck-rememberme" checked="">
                <label for="chck-rememberme">Remember me</label>
            </fieldset>
            -->
            <a href="#" id="btnLogin" class="ui-btn ui-btn-b ui-corner-all mc-top-margin-1-5">Submit</a>
            <a href="#" id="add-button" class="add-button ui-btn ui-btn-b ui-corner-all mc-top-margin-1-5">Add to home screen</a>
<!--
<button class="add-button">Add to home screen</button>            
-->
            <!-- we need to move this exit button into the gear icon in the header -
            Note that this only works on mobile, need to hide this button on desktop -->
            <!--  have to try this aftwe we compile with Phone Gap
            <a href="#" id="btnClose" class="ui-btn ui-btn-b ui-corner-all mc-top-margin-1-5">Close</a>
          -->
        <!-- button for teting things  
        <input type="button" id="tst" name="tst"/>
          -->

            <!--
            <p class="mc-top-margin-1-5"><a href="begin-password-reset.html">Can't access your account?</a></p>
            -->
            <div data-role="popup" id="dlg-invalid-credentials" data-dismissible="false" style="max-width:400px;">
                <div role="main" class="ui-content">
                    <h3 class="mc-text-danger">Login Failed</h3>
                    <p>Did you enter the right credentials?</p>
                    <div class="mc-text-center"><a href="#" id="dlg0closeBtn" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-b mc-top-margin-1-5">OK</a>
                    </div>
                </div>
            </div>
            
            
         
            <div data-role="popup" id="dlg-installApp" data-dismissible="false" style="max-width:400px;">
                <div role="main" class="ui-content">
                    <h3>Install to Desktop?</h3>
                    <p>For a better experience, install the app to your desktop.?</p>
                        <a href="#" id="btnInstall" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Install</a>
                        <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Not Now</a>
                </div>
            </div>
            
       
        
            
        </div><!-- /content -->
     </div>
    <!-- End Login Page -->
     
     
     
     
     
     
     
     
     
     
     
     <!-- Begin Device Selection Page -->
      <div data-role = "page" id="SelectDevice" data-theme="a">

        <div data-role="header"  data-theme="b"  data-position="fixed" >
          <a href="#" id="btnLogout" data-icon="user" class="ui-btn-left" data-transition="slide">Logout</a>        
          <h1>&nbsp;</h1>
        	<a href="#" id="refreshDevice" data-icon="refresh" class="ui-btn-right" data-transition="slide">Refresh List</a>
        </div> <!-- /header -->       

      
      
      
         <div data-role = "main" class = "ui-content">
            <form method = "post" action="#">
               

                <div class="ui-field-contain">
                   <label for = "selDevice">Device</label> 
                   <select name = "selDevice" id = "selDevice"  class="DeviceSelectionContainer" onchange="isDeviceAvailable(this)" >
            		<option>Select a device...</option>
                   </select>
                </div>

     
            </form>
         </div>
        	<div data-role="footer"  data-theme="b"  data-position="fixed">
        		<h1>NexDoor</h1>
        	</div><!-- /footer -->
         
      </div> <!-- Device Selection page  -->

     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     

      <div data-role = "page" id="Home" data-theme="a">
<!--
         <div data-role = "header">
            <h2>NexDoor Controller</h2>
         </div>
-->
        <div data-role="header"  data-theme="b"  data-position="fixed" >
        	<a href="#" id="btnLogout2" data-icon="user" class="ui-btn-left" data-transition="slide">Logout</a>
        	<h1>&nbsp;</h1>
        	<a href="#two" id="two" data-icon="gear" class="ui-btn-right" data-transition="slide">Configure</a>
        </div> <!-- /header -->       

      
      
         <div data-role = "main" class = "ui-content">
            <form method = "post" action="#">

        <div id="dcalc" name="dcalc" class="dcalc">
                    
        <div class="ui-field-contain">
            <a href="#SelectDevice" data-role="button"  id="DeviceName">xxxxxx</a>
        </div>
      
                   
                    

                <div class="containing-element">
                <div class="ui-field-contain">
                	<label for="cb1">Fan control</label>
                	<select name="cb1" id="cb1" data-role="slider">
                		<option value="0">Off</option>
                		<option value="1">On</option>
                	</select>
                </div>
                </div>
                
                <div class="containing-element">
                 <div class="ui-field-contain">
                	<label for="cb2">Baffel Position</label>
                	<select name="cb2" id="cb2" data-role="slider">
                		<option value="c">Closed</option>
                		<option value="o">Open</option>
                	</select>
                </div>
                </div>
                
                
                <div class="ui-field-contain">
                    <fieldset data-role="controlgroup" data-type="horizontal">
                    	<legend>Fan Speed</legend>
                         	<input type="radio" name="rbFanSpeed" id="rbFanSpeed1" value="l" />
                         	<label for="rbFanSpeed1">Low</label>
                
                         	<input type="radio" name="rbFanSpeed" id="rbFanSpeed2" value="m"  />
                         	<label for="rbFanSpeed2">Medium</label>
                
                         	<input type="radio" name="rbFanSpeed" id="rbFanSpeed3" value="h" />
                         	<label for="rbFanSpeed3">High</label>
                    </fieldset>
                </div>


             <!-- weather and AQI -->

                <h3>Weather and AQI from Device</h3>
                          
            	<div class="ui-field-contain">
                   	<!-- Temperature -->
                       <label for = "lblTemp">Temperature</label>
                       <input type = "text" name = "lblTemp" id = "lblTemp" readonly  style="font-weight: bold;">
                </div>
            
            	<div class="ui-field-contain">
            		<!-- humidity -->
                       	<label for = "lblHumid">Humidity</label>
                        <input type = "text" name = "lblHumid" id = "lblHumid" readonly style="font-weight: bold;">
                </div>
            
            	<div class="ui-field-contain">
            		<!-- LstWeatherUpdate -->
                        <label for = "lblWeatherRefresh">Last Weather Refresh</label>
                        <input type = "text" name = "lblWeatherRefresh" id = "lblWeatherRefresh" readonly  style="font-weight: bold;">
                </div>
            
<!--
these are the styles for AQI

Good  style="background-color:#0C0;color:#000;" 
Moderate   style="background-color:#FFFF00;color:#000;"
Unhealthy for Sensitive Groups  style="background-color:#FF9900;color:#000;"
Unhealthy  style="background-color:#FF0000;color:#FFF;"
Very Unhealthy  style="background-color:#990066;color:#FFF;"
Hazzardous   style="background-color:#660000;color:#FFF;"

-->
            	<div class="ui-field-contain">
            		<!-- PM25 -->
                        <label for = "lblPM25">PM 2.5</label>
                        <input type = "text" name = "lblPM25" id = "lblPM25" readonly value="" style="font-weight: bold;">
                </div>
            
            	<div class="ui-field-contain">
            		<!-- PM10 -->
                        <label for = "lblPM10">PM 10</label>
                        <input type = "text" name = "lblPM10" id = "lblPM10" readonly value="" style="font-weight: bold;">
                </div>
            
            	<div class="ui-field-contain">
            		<!-- Ozone -->
                        <label for = "lblO3">Ozone</label>
                        <input type = "text" name = "lblO3" id = "lbl03" readonly value="" style="font-weight: bold;">
                </div>
            
            	<div class="ui-field-contain">
            		<!-- LstAQIUpdate -->
                        <label for = "lblAQIRefresh">Last AQI Refresh</label>
                        <input type = "text" name = "lblAQIRefresh" id = "lblAQIRefresh" readonly style="font-weight: bold;">
            
                </div>
            
            <!-- End weather and AQI -->


                <h3>Status</h3>
                
                <div data-role="tabs" id="tabs">
                  <div data-role="navbar">
                    <ul>
                      <li><a href="#status" id="statusTab" data-ajax="false"  class="ui-btn-active ui-state-persist">Status</a></li>
                      <li><a href="#log" data-ajax="false">Log</a></li>
                     </ul>
                  </div>
                  <div id="status"><p id="myspan" name="myspan" ></p></div>
                  <div id="log"><p id="logSection" name="logSection"></p></div>
                </div>                  
                                
              <!-- if the page header does not work out, then we can use the buttons
              <p><a href="#two" data-role="button" data-icon="gear">Configure Device</a></p>
                -->
                
                <!-- Popup - Please Select a Device -->
            <div data-role="popup" id="dlg-select-device" data-dismissible="true" style="max-width:400px;">
                <div role="main" class="ui-content">
                    <h3 class="mc-text-danger">Please Select a Device</h3>
                    <div class="mc-text-center"><a href="#" id="dlg1closeBtn" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-b mc-top-margin-1-5">OK</a></div>
                </div>
            </div>

            </div> <!-- end dcalc div -->        
     
            </form>
         </div>


        <div data-role="footer" id="btnRefreshPage" data-theme="b"  data-position="fixed">
        	<a href="#" id="refreshPageVars" data-icon="refresh">Refresh Page</a>
        </div> <!-- /footer -->       

         
      </div> <!-- home page  -->
      
      
      
      
      
      
      
      
      
      

        <!-- Start of second page: #two -->
        <div data-role="page" id="two" data-theme="a">
        

 
        <div data-role="header"  data-theme="b" data-position="fixed">
        	<a href="#Home" data-icon="delete" id="cancelConfig" data-transition="slide" data-direction= "reverse">Cancel</a>
        	<h1>&nbsp;</h1>
        	<a href="#Home" data-icon="check" onclick="doSaveConfig()"  data-transition="slide" data-direction= "reverse">Save</a>
        </div> <!-- /header -->       

                
<!--       
<div data-role="popup" id="popupConfigRequiredFlds" class="ui-content" style="max-width:280px" data-dismissible="false">
    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-left">Close</a>
<p>Please enter a value for ALL fields.</p>
</div>
-->

            <div data-role="popup" id="dlg-Config-RequiredFlds" data-dismissible="false" style="max-width:400px;">
                <div role="main" class="ui-content">
                    <h3 class="mc-text-danger">Please Supply a Value for All Fields</h3>
                    <div class="mc-text-center"><a href="#" id="dlg2closeBtn" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-b mc-top-margin-1-5">OK</a></div>
                </div>
            </div>



        	<div role="main" class="ui-content">


            <form method = "post" action="#">

                <div >
                    <label name="lblSelectedDevice" id="lblSelectedDevice">XXXXXXX</label>
                </div>


                <!-- System Mode -->
                <div class="containing-element">
                 <div class="ui-field-contain">
                	<label for="cbDeviceMode">Device Mode</label>
                	<select name="cbDeviceMode" id="cbDeviceMode" data-role="slider" required>
                		<option value="0">Manual</option>
                		<option value="1">Auto</option>
                	</select>
                </div>
                </div>

       
       
                
                <!-- Default Fan Speed -->
                <div class="ui-field-contain">
                    <fieldset data-role="controlgroup" data-type="horizontal">
                    	<legend>Default Fan Speed</legend>
                         	<input type="radio" name="rbDefaultFanSpeed" id="rbDefaultFanSpeed1" value="84" />
                         	<label for="rbDefaultFanSpeed1">Low</label>
                
                         	<input type="radio" name="rbDefaultFanSpeed" id="rbDefaultFanSpeed2" value="169"  />
                         	<label for="rbDefaultFanSpeed2">Medium</label>
                
                         	<input type="radio" name="rbDefaultFanSpeed" id="rbDefaultFanSpeed3" value="255" />
                         	<label for="rbDefaultFanSpeed3">High</label>
                    </fieldset>
                </div>

                <!-- Weather Stations -->
                <!-- full list can be found here: https://www.nws.noaa.gov/mdl/synop/stadrg.php -->
                <div class="ui-field-contain">
                   <label for = "selWeatherSta">Weather Stations (AZ)</label>
                   <select name = "selWeatherSta" id = "selWeatherSta"  class="selWeatherSta"  required>
            		<option>Select a weather station...</option>
                    <option value="KCGZ">Casa Grande - KCGZ</option>
                    <option value="KCHD">Chandler - KCHD</option>
                    <option value="KDMA">Davis-Monthan AFB - KDMA</option>
                    <option value="KDUG">Douglas - KDUG</option>
                    <option value="KDVT">Deer Vly/Phoenix - KDVT</option>
                    <option value="KFHU">FT Huachuca - KFHU</option>
                    <option value="KFLG">FLAGSTAFF - KFLG</option>
                    <option value="KGBN">Gila Bend - KGBN</option>
                    <option value="KGCN">Grand Canyon - KGCN</option>
                    <option value="KGEU">Glendale Muni AP - KGEU</option>
                    <option value="KGYR">Goodyear - KGYR</option>
                    <option value="KIFP">Bullhead City - KIFP</option>
                    <option value="KIGM">Kingman - KIGM</option>
                    <option value="KINW">Winslow - KINW</option>
                    <option value="KIWA">Chandler - KIWA</option>
                    <option value="KLUF">Luke AFB - KLUF</option>
                    <option value="KNYL">Yuma MCAS - KNYL</option>
                    <option value="KOLS">Nogales Internatnl - KOLS</option>
                    <option value="KPGA">Page - KPGA</option>
                    <option value="KPHX">Phoenix - KPHX</option>
                    <option value="KPRC">Prescott - KPRC</option>
                    <option value="KRQE">Window Rock- KRQE</option>
                    <option value="KSAD">Safford - KSAD</option>
                    <option value="KSDL">Scottsdale - KSDL</option>
                    <option value="KSJN">St. Johns Air Park - KSJN</option>
                    <option value="KSOW">Show Low - KSOW</option>
                    <option value="KTUS">Tucson - KTUS</option>
                    </select>
                </div>


                <!-- Zip Code -->
               <label for = "txtZipcode">Zip Code</label>
                  <input type = "text" name = "txtZipcode" id = "txtZipcode" 
                     placeholder = "90210" required  minlength="5" maxlength="10">


                <!-- Refresh Rate, in minutes -->
                <div class="ui-field-contain">
                   <label for = "selRefreshRate">API Refresh Rate</label>
                   <select name = "selRefreshRate" id = "selRefreshRate"  class="selRefreshRate"  required>
            		<option>Select Number of Minutes Between API Calls...</option>
                    <option value="5">5 Minutes</option>
                    <option value="10">10 Minutes</option>
                    <option value="15">15 Minutes</option>
                    <option value="20">20 Minutes</option>
                    <option value="25">25 Minutes</option>
                    <option value="30">30 Minutes</option>
                    <option value="45">45 Minutes</option>
                    <option value="60">60 Minutes</option>
                    <option value="90">90 Minutes</option>
                    <option value="120">120 Minutes</option>
                    <option value="180">180 Minutes</option>
                    <option value="240">240 Minutes</option>
                    </select>
                </div>


                <!-- Local Timezone Offset -->
                <div class="ui-field-contain">
                   <label for = "selTimeZoneOffset">Time Zone</label>
                   <select name = "selTimeZoneOffset" id = "selTimeZoneOffset"  class="selTimeZoneOffset"  required>
            		<option>Select Your Timezone</option>
                    <option value="-4">Eastern Daylight Time - New York</option>
                    <option value="-5">Central Daylight Time - Chicago</option>
                    <option value="-6">Mountain Daylight Time - Salt Lake City</option>
                    <option value="-7">Mountain Standard Time - Phoenix</option>
                    <option value="-7">Pacific Daylight Time - Los Angeles</option>
                    <option value="-8">Alaska Daylight Time - Anchorage</option>
                    <option value="-10">Hawaii Standard Time - Honolulu</option>
                    </select>
                </div>


                <!-- Observe DST -->
                <div class="containing-element">
                 <div class="ui-field-contain">
                	<label for="cbObserveDST">Observe DST</label>
                	<select name="cbObserveDST" id="cbObserveDST" data-role="slider" required>
                		<option value="0">No</option>
                		<option value="1">Yes</option>
                	</select>
                </div>
                </div>
 

                <!-- Number of Installed NexDoor Fans -->
                <div class="ui-field-contain">
                    <label for="spinNumFans">Number of NexDoor Fans</label>
                    <input type="number" data-role="spinbox" name="spinNumFans" id="spinNumFans" value="1" min="1" max="10" required />
                </div>

                <!-- Sq. Footage of Location -->
                <div class="ui-field-contain">
                    <label for="spinSqFeet">Square Footage</label>
                    <input type="number" data-role="spinbox" name="spinSqFeet" id="spinSqFeet" value="1500" min="500" max="10000" required />
                </div>


                <!-- Debug Mode -->
                <div class="containing-element">
                 <div class="ui-field-contain">
                	<label for="cbDebugMode">Debug Mode</label>
                	<select name="cbDebugMode" id="cbDebugMode" data-role="slider" required>
                		<option value="0">Off</option>
                		<option value="1">On</option>
                	</select>
                </div>
                </div>

                
              <!-- if the page header does not work out, then we can use the buttons
             <p><a href="#Home" data-role="button" data-icon="check">Save</a></p>
             <p><a href="#Home" data-role="button" data-icon="delete">Cancel</a></p>
            -->

            </form>
            
        	</div><!-- /content -->
        
        	<div data-role="footer" data-theme="b"  data-position="fixed">
        		<h1>NexDoor</h1>
        	</div><!-- /footer -->
        </div><!-- /page two -->      






        <script>
        
        var particle = new Particle();
        var accessToken = '';
        var DeviceId = '';
        var DeviceName = '';
        var wasClosedDialog = false;
        var eventStream;
/////////////////////////////////
        

        
//  $(document).on('pagecreate', function() 
  $(document).on('pageinit', function() 
    {
          // when form first loads, disable all inputs until user has selected a device, and that device is online.
         if ( $("#selDevice")[0].selectedIndex == 0)
         {
             $("#dcalc").hide();
         }


        // fall back to this if meta tags dont work from desktop
        // SetFullScreen();    
        
        window.history.forward();

    });
        
/////////////////////////////////
        
        function callParticle_Func(command, args)
          {
           
        	$("body").css("cursor", "progress");
        
        
            document.getElementById("myspan").innerHTML="Waiting... ("+command+"/"+args+")";
            document.getElementById("logSection").innerHTML=getFormattedDateTime()+' Requesting: '+command+'/'+args+'<br />'+document.getElementById("logSection").innerHTML;
           
           var fnPr = particle.callFunction({ deviceId: DeviceId, name: command, argument: args, auth: accessToken });
        
           fnPr.then(
             function(data) 
               {
          	     document.getElementById("myspan").innerHTML="done: <br />Device: "+DeviceName+"\n/"+command+"/"+args+"<p><pre>"+JSON.stringify(data.body, null, "   ")+"</p></pre>";
        
        	     document.getElementById("logSection").innerHTML=getFormattedDateTime()+' Request Success-> ['+DeviceName+'] '+command+'/'+args+'<br />'+document.getElementById("logSection").innerHTML;
              }, 
            function(err) 
              {
                document.getElementById("myspan").innerHTML="ERROR !<br />Message: "+err; 
        	    document.getElementById("logSection").innerHTML=getFormattedDateTime()+' failed<br />'+document.getElementById("logSection").innerHTML;        
              }).finally(function(info){ $("body").css("cursor", "default");
            });   
           
        }
        
        
/////////////////////////////////
        
    // toggle baffle open/closed
    // closing the baffle will turn off the fan if it is on
    $('#cb2').on('change', function() {
      //alert( this.value );
      callParticle_Func("go",this.value);

        // if baffel is closed, then update the fan status slider to reflect off
      if (this.value == 'c')
      {
          //  refresh the status slideer for the fan.. keep it in sync
          $(cb1).prop("checked", false);
          $('#cb1').val('0');
          $('#cb1').slider( "refresh" ); 
          
      }
    })
        
/////////////////////////////////
        
    // toggle fan on/off    
    // baffle is opened and closed with fan on/off
    $('#cb1').on('change', function() {
      //alert( this.value );
     callParticle_Func("fan",this.value);

        // if the fan is turned on, then update baffle slider to reflect open
      if (this.value == '1')
      {
          //  refresh the status slideer for the fan.. keep it in sync
          $(cb2).prop("checked", true);
          $('#cb2').val('o');
          $('#cb2').slider( "refresh" ); 
          
      }
    
        // if the fan is turned off, then update baffle slider to reflect closed
      if (this.value == '0')
      {
          //  refresh the status slideer for the fan.. keep it in sync
          $(cb2).prop("checked", false);
          $('#cb2').val('c');
          $('#cb2').slider( "refresh" ); 
          
      }

    })
    
    
// Configure Click - Verify a device was selected    
/////////////////////////////////
    $('#two').on('click', function() {
    

     if ( $("#selDevice")[0].selectedIndex == 0)
       {
         console.log('No Device Selected');
         event.preventDefault();
         $("#dlg-select-device" ).popup( "open" );
       }
       
    })
    
    
    
/////////////////////////////////

    // set fan speed
    $("input[name='rbFanSpeed']" ).on('click', function() {
      callParticle_Func("fanSpeed",this.value);
    })
        



    // Cancel Configuration
    $("#cancelConfig").on('click', function(){
    // need to reset origianl values to all inputs on config page 
    
     // Post config values to cloud
     callParticle_Func("GetCurrentConfigs","0");

     
    });
    
    
 
 
    //  login
    $("#btnLogin").on('click', function(){
       // particle.login({username: 'NDParticleDev@gmail.com', password: 'p8rtic1ei0'}).then(
 
        particle.login({username: $("#txt-email").val(), password: $("#txt-password").val()}).then(
          function(data) {
            accessToken = data.body.access_token;
            // we are now handling the list devices in the drop down, so after login, go directly to device page
            //ListDevices(accessToken)
            $.mobile.changePage( "#SelectDevice", { transition: "slide", changeHash: true });

          },
          function (err) {
            event.preventDefault();
            $("#dlg-invalid-credentials" ).popup( "open" );
          }
        );    
     
    });
    



// Close the app...
// this is not working.. can only close the window that the app opened...
// need to figure out how to exit the app!
$("#btnClose").on('click', function()
    {

     //window.close();
     // the following line should work in PhoneGap
        navigator.app.exitApp();


    });



            



// Logout button handler
$("#btnLogout").on('click', function()
    {
         particle.deleteCurrentAccessToken({ auth: accessToken }).then(function(data) {
          console.log('Deleted Current Access Token: ', data);
        }, function(err) {
          console.log('Error Deleting Access Tokens: ', err);
        });     
        
        // initialize settings
        accessToken = '';
        DeviceId = '';
        DeviceName = '';

        $('#selDevice')[0].selectedIndex = 0;
        $("#selDevice").selectmenu("refresh");
        $("#selDevice" ).trigger( "change" );

        // take user to the login screen
        $.mobile.changePage( "#Login", { transition: "slide", reverse: true, changeHash: true });
        

    });
    
    
$("#btnLogout2").on('click', function()
    {

       $("#btnLogout").trigger("click");

    });
    

// the user cliecked the refresh page button in the footer of the main page
$("#btnRefreshPage").on('click', function()
    {
        callParticle_Func("GetCurrentFanState","0");
        callParticle_Func("GetCurrentVars","0");
    });
    
    

/*
// we need to figure out how to prevent going back via the back button.. might need to look at the ui object
// and comare from and to.... might need to use before chage if one exists.. and prevent default if going backwards
$(document).on( "pagecontainerchange", function( event, ui )
{

        window.history.forward();
console.log(event);
console.log(ui);
})
*/

/*
 $( window ).on( "navigate", function( event, data ){

    if (data.state.direction === 'back')
    {
        console.log( data.state.direction );
        event.preventDefault();
        $.mobile.changePage( data.state.url, {changeHash: true });
        //history.go(1);
    }
    
    console.log('navigate Event Happened');
    console.log( data.state.url );
    //console.log( data.state.hash );
  });


$(document).on("pagecontainerbeforetransition", function(e, data) 
{
  console.log("to", data.toPage[0].id);
  
  if (data.prevPage !== undefined)
  {
   console.log("from", data.prevPage[0].id);
  }
  else{
    console.log("from nowhere");
  }  
  
  
  
    if (data.direction === 'back')
    {
        console.log( ' ----> BACK <----' );
        event.preventDefault();
    }
  
  
});



$(document).on("pagecontainerbeforetransition", function (e, data) 
{
      var fromPage = '#login';
      
  if (data.options.direction == "back" || data.options.direction == "forward") 
   {
         console.log("to", data.toPage[0].id);
        
          if (data.prevPage !== undefined)
          {
           fromPage = '#'+data.prevPage[0].id;
           console.log("from", fromPage);
          }
          else{
            console.log("from nowhere");
          }
        
        
         if (data.options.reverse === true)
          {
           console.log("BACK", data.options.reverse);
          }
          else{
           console.log("FORWARD", data.options.reverse);
          }
          
        // data.toPage = fromPage; 
         //$.mobile.pageContainer.pagecontainer("change", fromPage); 

    if (typeof data.toPage == "string") {
        //data.toPage = '#login';
    e.preventDefault();
    console.log(data.prevPage);
    }

   }


    
});

*/

/*

// this seems to be the best option yet.. but url in address bar is not correct
// and my cause a problem if user refreshes page.
// need to find out how to keep the address bar in synch with actual page
$(document).on("pagecontainerbeforechange", function (e, data) 
{

    if (typeof data.toPage == "string" && data.options.direction == "back" && data.prevPage[0].id == "Home") 
    {
        data.toPage = $("#Login"); 
        data.options.fromHshChange = true;
       
    }

    if (typeof data.toPage == "string" && data.options.direction == "back" && data.prevPage[0].id == "two") 
    {
        data.toPage = $("#Login"); 
        data.options.fromHshChange = true;
    }

    if (typeof data.toPage == "string" && data.options.direction == "back" && data.prevPage[0].id == "Login") 
    {
        data.toPage = $("#Login"); 
        data.options.fromHshChange = true;
    }
    
}
);
  */  


// this is not perfect, but is best so far
$(document).on("pagecontainerbeforechange", function (e, data) {
    if (typeof data.toPage === "string" && data.options.direction === "back" && wasClosedDialog === false) {
        data.toPage = "#Login";
        data.options.transition = "slide";
        data.options.changeHash = false;
        
        // might need to use history.pushState() here
        // https://css-tricks.com/using-the-html5-history-api/
        // since the issue we are having is that the has of the url is not changing to match the actual page we are on
        $("#btnLogout" ).trigger( "click" );
        
        // also might want to try this somewhere in this handerl
        // e.stopPropagation();
        // and maybe return false ??
    }
    
    wasClosedDialog = false;
});



// raise a flag when a dialog was closed, so that we don't trigger a "back" event and end up on the login screem    
$("#dlg0closeBtn").on('click', function(){
    
  wasClosedDialog = true;
     
});


// raise a flag when a dialog was closed, so that we don't trigger a "back" event and end up on the login screem    
$("#dlg1closeBtn").on('click', function(){
    
  wasClosedDialog = true;
     
});



// raise a flag when a dialog was closed, so that we don't trigger a "back" event and end up on the login screem    
$("#dlg2closeBtn").on('click', function(){
    
  wasClosedDialog = true;
     
});


// laod/refresh the device select list    
$("#refreshDevice").on('click', function(){
    
   ListDevices(accessToken);
   console.log('Refresh Device');
});





// list devices
function ListDevices(accessToken)
{
        var devicesPr = particle.listDevices({ auth: accessToken });
        
        devicesPr.then(
          function(devices){
            PopulateDeviceSelectList(devices);
          //  $.mobile.changePage( "#Home", { transition: "slide", changeHash: true });
          },
          function(err) {
            console.log('List devices call failed: ', err);
          }
        );    
}


// add devices to device selection box
function PopulateDeviceSelectList(devices)
{

    var NumDevices = Object.keys(devices.body).length;
    
    var deviceList = "";
  
    // empty select list so we can add current devices
    $('#selDevice').find('option').remove();  
    let newOption = new Option("Select a device...", "")
    $('#selDevice').append(newOption);

    // add active devices to the list
    for (i=0; i<NumDevices; i++)
      {
          if (devices.body[i].online === true)
          {
               let newOption = new Option(devices.body[i].name, devices.body[i].id);
              $('#selDevice').append(newOption);
          }
      }

    // need to refresh Jquery Mobile UI      
    $('#selDevice').selectmenu('refresh');
}


    // save Configuration Data
    function doSaveConfig()
    {
       
        var squareFeetBuildingSize = parseInt($("#spinSqFeet").val(), 10); 
        var numberOfNexDoorFans = parseInt($("#spinNumFans").val(), 10);
        var CallWebhookEveryMinutes = parseInt($("#selRefreshRate").val(), 10);
        var localTimeZoneOffset = parseInt($("#selTimeZoneOffset").val(), 10);
        var observeDST = parseInt($("#cbObserveDST").val(), 10);
        var WeatherStation = $("#selWeatherSta").val();
        var zipcode = $("#txtZipcode").val();
        var debugMode = parseInt($("#cbDebugMode").val(), 10);
        //var debugMode = ($("#cbDebugMode").val() === 'false') ? false : true;
        var DefaultFanSpeed = parseInt($("input[name='rbDefaultFanSpeed']:checked").val(), 10);
        var SystemMode = parseInt($("#cbDeviceMode").val(), 10);


        
        var configObj = { squareFeetBuildingSize: squareFeetBuildingSize, 
        				numberOfNexDoorFans: numberOfNexDoorFans, 
                        CallWebhookEveryMinutes: CallWebhookEveryMinutes,
                        localTimeZoneOffset: localTimeZoneOffset,
                        observeDST: observeDST,
                        WeatherStation: WeatherStation,
                        zipcode: zipcode,
                        debugMode: debugMode,
                        DefaultFanSpeed: DefaultFanSpeed,
                        SystemMode: SystemMode
                        };
        var myJSON = JSON.stringify(configObj);



    // need to chack for requiered fields here.. if any are blank, then 
    //  event.preventDefault();
      // else continue on

        if (isNaN(configObj.squareFeetBuildingSize) ||
            isNaN(configObj.numberOfNexDoorFans) ||
            isNaN(configObj.CallWebhookEveryMinutes) ||
            isNaN(configObj.localTimeZoneOffset) ||
            configObj.WeatherStation === "Select a weather station..." ||
            configObj.zipcode === "" ||
            isNaN(configObj.DefaultFanSpeed))
            {
                event.preventDefault();
                //$("#popupConfigRequiredFlds" ).popup( "open" );
                $("#dlg-Config-RequiredFlds" ).popup( "open" );
                
            }
        else
        {
       
             // Post config values to cloud
             callParticle_Func("SaveConfigs",myJSON);
             
             // the device will send an event that will indicate success or failure...
             // When we recive the event, all form elemetns will be either updated to match current values
            // so on failure, the form elements will be reset to actual values on device.
            
        }

   };




  // this is where we can execute code for each page         
 $(document).on("pagebeforeshow", function() 
 {
   //this will get the active page id (like #page1)
   var currentPage = $.mobile.activePage.attr('id');
   //console.log(currentPage); 
  
  // if for some reason a user lands on a page without loging in, then redirect to login page
  if (currentPage !== 'Login' && accessToken === '')
  {
    $.mobile.changePage( "#Login", { transition: "slide", changeHash: true }); 
    return;
  }
  
  if (currentPage == 'SelectDevice') 
  {
    ListDevices(accessToken);
  }
  
  if (currentPage == 'Home') 
  {
      $("#statusTab").trigger("click");
  }

  
  /*
  if (currentPage == 'two')
  {
      $("#selWeatherSta").selectmenu('refresh');
      $("#selRefreshRate").selectmenu('refresh');
      $("#selTimeZoneOffset").selectmenu('refresh');
      
      $("#cbDeviceMode").checkboxradio( "refresh" );
      $("#cbDebugMode").checkboxradio( "refresh" );
      $("#cbObserveDST").checkboxradio( "refresh" );
      $("#rbDefaultFanSpeed").checkboxradio( "refresh" );
      

      
  }
    
    */ 
 }); 
        
        
        
        
        // Check Device Availability
        function isDeviceAvailable(obj)
        {
        
          DeviceName = obj.options[obj.selectedIndex].text;
          DeviceId = obj.value;
          
          
          $("#lblSelectedDevice").html(DeviceName);
          
          if (obj.selectedIndex === 0)
          {
            DeviceName = "No Device Selected" 
            //$("#dcalc").disabled = 
            $("#dcalc *").prop('disabled',true);
        	$("#dcalc").hide();

            $("#DeviceName").html(DeviceName);
            $("#DeviceName").css({ 'color': 'black', 'font-size': '100%' });
          } 
          else if (obj.selectedIndex > 0)
          {
            $("#dcalc *").prop('disabled',false);
        	$("#dcalc").show();
            $("#DeviceName").html(DeviceName);
            $("#DeviceName").css({ 'color': 'green', 'font-size': '100%' });
            
             $.mobile.changePage( "#Home", { transition: "slide", changeHash: true });
             
             // abort any streams we may have been listening too prior to channging devices
            if (typeof eventStream !== 'undefined')
            {
              eventStream.abort();
            }

            // this captures the events for the selected device
            particle.getEventStream({ deviceId: DeviceId, name: "device-config", auth: accessToken}).then(function(stream) {
              // store a referrence to the event stream so we can abort when we change devices alter.
              eventStream = stream;
              eventStream.on('event', function(feed) {
                // insert code to do something with feed.data
               var myObj = JSON.parse(feed.data);
                //console.log(myObj.Event);
                
                switch(myObj.Event) {
                                      case "GetVars":
                                        doGetVars(myObj);
                                        break;
                                      case "GetConfigs":
                                        doGetConfigs(myObj);
                                        break;
                                      case "GetFanState":
                                        doGeFanState(myObj);
                                        break;
                                      default:
                                        // code block
                                    }
              });
            });
        

                // signal device to se3nd current status/values
                callParticle_Func("GetCurrentFanState","0");
                callParticle_Func("GetCurrentVars","0");
                callParticle_Func("GetCurrentConfigs","0");
                
                
            
          }
          /*
          // if device is not online, or error occurs, disavble rest of form.
          else if (DeviceName != "No Device Selected")
          {
            $("#dcalc *").prop('disabled',true);
        	$("#dcalc").hide();
           //$('#cb1').button('disable');	
            $("#DeviceName").html("Device Offline");
            $("#DeviceName").css({ 'color': 'red', 'font-size': '150%' });
        }
          */



function doGeFanState(myObj)
{
    //console.log(myObj.FanState);
    
     // fan button
       $("#cb1").val(myObj.FanState).slider("refresh");


   // baffle button
       $("#cb2").val(myObj.BafflePos).slider("refresh");
   
   
   // speed button
     if (myObj.CurrentFanSpeed === 255) {
    
            $( "#rbFanSpeed1" ).prop( "checked", false ).checkboxradio( "refresh" );
            $( "#rbFanSpeed2" ).prop( "checked", false ).checkboxradio( "refresh" );
            $( "#rbFanSpeed3" ).prop( "checked", true ).checkboxradio( "refresh" );
        }
        else if (myObj.CurrentFanSpeed === 169) {
            $( "#rbFanSpeed1" ).prop( "checked", false ).checkboxradio( "refresh" );
            $( "#rbFanSpeed2" ).prop( "checked", true ).checkboxradio( "refresh" );
            $( "#rbFanSpeed3" ).prop( "checked", false ).checkboxradio( "refresh" );
        } 
        else  {
            $( "#rbFanSpeed1" ).prop( "checked", true ).checkboxradio( "refresh" );
            $( "#rbFanSpeed2" ).prop( "checked", false ).checkboxradio( "refresh" );
            $( "#rbFanSpeed3" ).prop( "checked", false ).checkboxradio( "refresh" );
        } 
   
}
        
        
function doGetVars(myObj)
{
    //console.log(myObj);
    
    // weather data
    let date = new Date(myObj.LastWeatherUpdate);
    $('#lblTemp').val(myObj.CurrentTemp+' '+String.fromCharCode(176)+'F');
    $('#lblHumid').val(myObj.CurrentHumidity+' %');
    $('#lblWeatherRefresh').val(date.toLocaleString());

    // weather data
    date = new Date(myObj.LastAQIUpdate);
    $('#lblPM25').val(myObj.AQI_PM25);
    $('#lblPM10').val(myObj.AQI_PM10);
    $('#lbl03').val(myObj.AQI_03);
    $('#lblAQIRefresh').val(date.toLocaleString());



    let backColor = '#00e400';
    let fontColor = 'black';
    
    // color for PM25
    switch(myObj.AQI_PM25) {
      case 'Good':
        backColor = '#00e400';
        fontColor = 'black';
        break;
      case 'Moderate':
        backColor = 'yellow';
        fontColor = 'black';
        break;
      case 'Unhealthy for Sensitive Groups':
        backColor = '#ff7e00';
        fontColor = 'white';
        break;
      case 'Unhealthy':
        backColor = 'red';
        fontColor = 'white';
        break;
      case 'Very Unhealthy':
        backColor = '#8f3f97';
        fontColor = 'white';
        break;
      case 'Hazzardous':
        backColor = '#7e0023';
        fontColor = 'white';
        break;
    }

    $("#lblPM25").css("background-color",backColor);
    $("#lblPM25").css("color",fontColor);


// color for PM10
    switch(myObj.AQI_PM10) {
      case 'Good':
        backColor = '#00e400';
        fontColor = 'black';
        break;
      case 'Moderate':
        backColor = 'yellow';
        fontColor = 'black';
        break;
      case 'Unhealthy for Sensitive Groups':
        backColor = '#ff7e00';
        fontColor = 'white';
        break;
      case 'Unhealthy':
        backColor = 'red';
        fontColor = 'white';
        break;
      case 'Very Unhealthy':
        backColor = '#8f3f97';
        fontColor = 'white';
        break;
      case 'Hazzardous':
        backColor = '#7e0023';
        fontColor = 'white';
        break;
    }

    $("#lblPM10").css("background-color",backColor);
    $("#lblPM10").css("color",fontColor);


// color for O3
    switch(myObj.AQI_PM25) {
      case 'Good':
        backColor = '#00e400';
        fontColor = 'black';
        break;
      case 'Moderate':
        backColor = 'yellow';
        fontColor = 'black';
        break;
      case 'Unhealthy for Sensitive Groups':
        backColor = '#ff7e00';
        fontColor = 'white';
        break;
      case 'Unhealthy':
        backColor = 'red';
        fontColor = 'white';
        break;
      case 'Very Unhealthy':
        backColor = '#8f3f97';
        fontColor = 'white';
        break;
      case 'Hazzardous':
        backColor = '#7e0023';
        fontColor = 'white';
        break;
    }


    $("#lbl03").css("background-color",backColor);
    $("#lbl03").css("color",fontColor);
    
}


function doGetConfigs(myObj)
{
  var curNode = "0";
  
try {
     // need to add this to the API
     // device Mode button
     //  $("#cbDeviceMode").slider().val(myObj.DeviceMode).slider("refresh");

     // debug Mode button
     curMode = myObj.debugMode === true ? "1" : "0";
      $("#cbDebugMode").slider().val(curMode).slider("refresh");

     // observe DST button
     curMode = myObj.observeDST === true ? "1" : "0";
      $("#cbObserveDST").slider().val(curMode).slider("refresh");


     // Default Fan Speed button
     if (myObj.DefaultFanSpeed === 255) {
    
            $( "#rbDefaultFanSpeed1" ).checkboxradio().prop( "checked", false ).checkboxradio( "refresh" );
            $( "#rbDefaultFanSpeed2" ).checkboxradio().prop( "checked", false ).checkboxradio( "refresh" );
            $( "#rbDefaultFanSpeed3" ).checkboxradio().prop( "checked", true ).checkboxradio( "refresh" );
        }
        else if (myObj.DefaultFanSpeed === 169) {
            $( "#rbDefaultFanSpeed1" ).checkboxradio().prop( "checked", false ).checkboxradio( "refresh" );
            $( "#rbDefaultFanSpeed2" ).checkboxradio().prop( "checked", true ).checkboxradio( "refresh" );
            $( "#rbDefaultFanSpeed3" ).checkboxradio().prop( "checked", false ).checkboxradio( "refresh" );
        } 
        else  {
            $( "#rbDefaultFanSpeed1" ).checkboxradio().prop( "checked", true ).checkboxradio( "refresh" );
            $( "#rbDefaultFanSpeed2" ).checkboxradio().prop( "checked", false ).checkboxradio( "refresh" );
            $( "#rbDefaultFanSpeed3" ).checkboxradio().prop( "checked", false ).checkboxradio( "refresh" );
        } 


    // ZipCode box
     $('#txtZipcode').val(myObj.zipcode);

    // Num Fans
     $('#spinNumFans').val(myObj.numberOfNexDoorFans);

    // Sq Feet
     $('#spinSqFeet').val(myObj.squareFeetBuildingSize);


    $("#selWeatherSta").selectmenu().val(myObj.WeatherStation).selectmenu('refresh');
    $("#selRefreshRate").selectmenu().val(myObj.CallWebhookEveryMinutes).selectmenu('refresh');
    $("#selTimeZoneOffset").selectmenu().val(myObj.localTimeZoneOffset).selectmenu('refresh');
    
    
    
}

catch(err) {
  console.log(err.message);
}

}
    
        
        
            
        
        }
        
        function getFormattedDateTime() 
          {
        
        	var d = new Date;
        
        	return '['+d.getFullYear()+'-'+ 
            			(d.getMonth() < 10 ? '0' : '') + d.getMonth()+'-'+
                        (d.getDate() < 10 ? '0' : '') + d.getDate()+' '+
                        (d.getHours() < 10 ? '0' : '')+d.getHours()+':'+
                        (d.getMinutes() < 10 ? '0' : '')+d.getMinutes()+':'+
                        (d.getSeconds() < 10 ? '0' : '')+d.getSeconds()+']';
        
             
          }
        
 
 // only used if we call from pageload....
 // first use meta tags... save shortcut to desktop and run from there...
 // if that does not work, remove the meta tags and aadd a call to this from the page load
 // Mmore info about full screen on mobile devices... 
 // https://www.creativebloq.com/html5/12-html5-tricks-mobile-81412803
 // https://developer.mozilla.org/en-US/docs/Web/API/Fullscreen_API
 // https://developer.mozilla.org/en-US/docs/Web/API/Fullscreen_API/Guide
 // for Chrome, we are using the manifest as described in the following link
 // https://developers.google.com/web/fundamentals/native-hardware/fullscreen
function SetFullScreen()
    {
    
        var body = document.documentElement;
        if (body.requestFullscreen) 
            {
                body.requestFullscreen();
            } 
        else if (body.webkitrequestFullscreen) /* Chrome, Safari and Opera */
            {
                body.webkitrequestFullscreen();
            } 
            
        else if (body.mozrequestFullscreen) /* Firefox */
            {
                body.mozrequestFullscreen();
            } 
        else if (body.msrequestFullscreen) /* IE/Edge */
            {
                body.msrequestFullscreen();
            }

   };


        </script>

  <script>
  
let deferredPrompt;
const addBtn = document.querySelector('.add-button');
addBtn.style.display = 'none';
      
window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent Chrome 67 and earlier from automatically showing the prompt
  e.preventDefault();
  // Stash the event so it can be triggered later.
  deferredPrompt = e;
  // Update UI to notify the user they can add to home screen
  addBtn.style.display = 'block';

  addBtn.addEventListener('click', (e) => {
    // hide our user interface that shows our A2HS button
    addBtn.style.display = 'none';
    // Show the prompt
    deferredPrompt.prompt();
    // Wait for the user to respond to the prompt
    deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the A2HS prompt');
        } else {
          console.log('User dismissed the A2HS prompt');
        }
        deferredPrompt = null;
      });
  });
});

     

  // Check to make sure the browser supports service workers
if ('serviceWorker' in navigator) 
{
  navigator.serviceWorker
    .register('https://nexdoor.github.io/service-worker.js')
    .then(() => 
    {
      console.log('Service worker registered');
    })
    .catch(err => 
    {
      console.log('Service worker registration failed: ' + err);
    });
}

</script>



      
   </body>
</html>